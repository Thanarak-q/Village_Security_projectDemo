services:
  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"               # ✅ ต้องเปิดเพื่อ HTTPS
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data        # ✅ เก็บใบรับรอง
      - caddy_config:/config
    depends_on:
      - frontend
      - backend
      - websocket
    networks:
      - default

  frontend:
    build: ./frontend
    environment:
      - WATCHPACK_POLLING=${CHOKIDAR_USEPOLLING}
      - CHOKIDAR_USEPOLLING=${CHOKIDAR_USEPOLLING}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_LIFF_ID=${NEXT_PUBLIC_LIFF_ID}
      - NODE_ENV=${NODE_ENV}
    expose:
      - "3000"                  # ✅ ใช้ภายใน docker network เท่านั้น
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - default

  backend:
    build: ./backend
    env_file:
      - ${ENV_FILE_PATH:-./.env}
    expose:
      - "3001"                  # ✅ ไม่ต้อง map ออกนอก
    volumes:
      - ./backend:/app
    depends_on:
      - websocket
      - minio
      - db
    restart: unless-stopped
    networks:
      - default

  websocket:
    build: ./websocket
    environment:
      - WS_PORT=${WS_PORT}
      - WS_PATH=${WS_PATH}
      - WS_IDLE_TIMEOUT=${WS_IDLE_TIMEOUT}
      - NODE_ENV=${NODE_ENV}
    expose:
      - "3002"                  # ✅ ภายในเท่านั้น
    volumes:
      - ./websocket:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - default

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
    expose:
      - "9000"                  # API ภายใน
      - "9001"                  # Console ภายใน
    volumes:
      - minio_data:/data
    restart: unless-stopped
    networks:
      - default

  db:
    image: postgres:16-alpine    # ✅ แก้เวอร์ชัน
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - dbdata:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - default

  # ใช้เฉพาะตอน dev เท่านั้น (โปรดักชันไม่ต้อง)
  # ngrok:
  #   image: ngrok/ngrok:latest
  #   command: ["http", "caddy:80", "--log=stdout", "--url=${URL}"]
  #   environment:
  #     NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
  #     URL: ${URL}
  #   ports:
  #     - "4040:4040"
  #   depends_on:
  #     - caddy
  #   restart: unless-stopped
  #   networks:
  #     - default

volumes:
  dbdata:
  minio_data:
  caddy_data:
  caddy_config:

networks:
  default:
    driver: bridge
